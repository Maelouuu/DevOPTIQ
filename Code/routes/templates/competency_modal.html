<!-- Code/routes/templates/competency_modal.html -->
<div id="competencyModalOverlay" class="modal-overlay-propose" style="display:none;" onclick="if(event.target === this) closeCompetencyModal()">
  <div id="competencyModal" class="modal-content-propose">
    <div class="modal-header-propose">
      <h3><i class="fa-solid fa-sparkles"></i> Propositions de compétences</h3>
      <button class="modal-close-btn-propose" onclick="closeCompetencyModal()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="modal-body-propose">
      <ul id="proposalsList" class="proposals-list-propose"></ul>
    </div>
    <div class="modal-footer-propose">
      <button class="btn-modal-secondary-propose" onclick="closeCompetencyModal()">
        <i class="fa-solid fa-xmark"></i> Annuler
      </button>
      <button class="btn-modal-primary-propose" onclick="validateAllSelectedProposals()">
        <i class="fa-solid fa-check"></i> Valider les compétences
      </button>
    </div>
  </div>
</div>

<script>
let proposalsGlobal = [];
let currentActivityId = null;

function showProposalsModal(proposals, activityId) {
  proposalsGlobal = proposals;
  currentActivityId = activityId;
  const proposalsList = document.getElementById('proposalsList');
  proposalsList.innerHTML = "";

  proposals.forEach((proposal, index) => {
    const li = document.createElement('li');
    const escaped = proposal.replace(/'/g, "\\'");
    li.innerHTML = `
      <label class="proposal-item-propose">
        <input type="checkbox" data-proposal="${escaped}" />
        <span>${proposal}</span>
      </label>
    `;
    proposalsList.appendChild(li);
  });

  document.getElementById('competencyModalOverlay').style.display = "flex";
}

function validateAllSelectedProposals() {
  const proposalsList = document.getElementById('proposalsList');
  const checkboxes = proposalsList.querySelectorAll('input[type="checkbox"]:checked');
  if (checkboxes.length === 0) {
    alert("Veuillez sélectionner au moins une proposition.");
    return;
  }

  let addPromises = [];
  checkboxes.forEach(cb => {
    const text = cb.getAttribute('data-proposal') || "Compétence ?";
    let p = fetch('/skills/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        activity_id: currentActivityId,
        description: text
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        console.error("Erreur en ajoutant la compétence:", data.error);
      } else {
        addCompetencyItemToDOM(currentActivityId, data.id, data.description);
      }
    })
    .catch(error => {
      console.error("Erreur /skills/add:", error);
    });
    addPromises.push(p);
  });

  Promise.all(addPromises).then(() => {
    closeCompetencyModal();
    alert("Compétences sauvegardées en base.");
  });
}

function closeCompetencyModal() {
  document.getElementById('competencyModalOverlay').style.display = "none";
}
</script>