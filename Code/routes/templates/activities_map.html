{% include "header_buttons.html" %}
<link rel="stylesheet" href="{{ url_for('static', filename='cartography.css') }}">

<script>
  // Variables globales pour le JavaScript
  window.CARTO_SHAPE_MAP = {{ shape_activity_map | tojson | safe }};
  window.SVG_EXISTS = {{ svg_exists | tojson }};
  window.ACTIVE_ENTITY = {{ active_entity | tojson | safe }};
  window.ALL_ENTITIES = {{ all_entities | tojson | safe }};
</script>

<script defer src="{{ url_for('static', filename='js/activities_map.js') }}"></script>

<div class="carto-page">

  <!-- HEADER -->
  <div class="carto-header">
    <div class="carto-header-left">
      <h1>Cartographie des activit√©s</h1>
      
      <!-- Badge entit√© active -->
      {% if active_entity %}
        <span class="entity-badge active">
          üè¢ {{ active_entity.name }}
        </span>
      {% else %}
        <span class="entity-badge inactive">
          ‚ö†Ô∏è Aucune entit√© active
        </span>
      {% endif %}
    </div>

    <div class="carto-header-right">
      <button id="entity-manager-btn" class="btn-entity-manager">
        üè¢ Gestionnaire d'entit√©s
      </button>
      <button id="carto-actions-btn" class="carto-actions-btn">
        ‚öôÔ∏è Actions cartographie
      </button>
    </div>
  </div>

  <!-- MESSAGE D'INFO NAVIGATION -->
  <div class="carto-info-message">
    <span>
      <strong>Navigation :</strong> 
      Clic gauche (drag) pour se d√©placer ‚Ä¢ 
      Molette pour zoomer ‚Ä¢ 
      Clic gauche sur une activit√© pour y acc√©der
    </span>
  </div>

  <!-- ============================================================
       POPUP GESTIONNAIRE D'ENTIT√âS
  ============================================================ -->
  <div id="entity-manager-popup" class="popup hidden">
    <div class="popup-content popup-large">
      
      <div class="popup-header">
        <h2>üè¢ Gestionnaire d'entit√©s</h2>
        <button id="close-entity-manager" class="btn-close">‚úï</button>
      </div>

      <div class="entity-manager-layout">
        
        <!-- Colonne gauche: Liste des entit√©s -->
        <div class="entity-list-section">
          <h3>Entit√©s disponibles</h3>
          
          <!-- Formulaire nouvelle entit√© -->
          <div class="new-entity-form">
            <input type="text" id="new-entity-name" placeholder="Nom de la nouvelle entit√©" />
            <button id="create-entity-btn" class="btn-green">+ Cr√©er</button>
          </div>
          
          <!-- Liste des entit√©s -->
          <ul id="entities-list" class="entities-list">
            {% for entity in all_entities %}
              <li class="entity-item {% if entity.is_active %}active{% endif %}" 
                  data-id="{{ entity.id }}">
                <span class="entity-name">{{ entity.name }}</span>
                {% if entity.is_active %}
                  <span class="entity-active-badge">Active</span>
                {% endif %}
              </li>
            {% else %}
              <li class="no-entity">Aucune entit√© cr√©√©e</li>
            {% endfor %}
          </ul>
        </div>

        <!-- Colonne droite: D√©tails de l'entit√© s√©lectionn√©e -->
        <div class="entity-details-section">
          <div id="entity-details-placeholder" class="entity-placeholder">
            <p>üëà S√©lectionnez une entit√© pour voir ses d√©tails</p>
          </div>
          
          <div id="entity-details" class="entity-details hidden">
            <h3 id="entity-detail-name">Nom de l'entit√©</h3>
            <p id="entity-detail-description" class="entity-description"></p>
            
            <div class="entity-stats">
              <div class="stat-item">
                <span class="stat-value" id="entity-activities-count">0</span>
                <span class="stat-label">Activit√©s</span>
              </div>
              <div class="stat-item">
                <span class="stat-value" id="entity-svg-status">-</span>
                <span class="stat-label">Cartographie</span>
              </div>
            </div>
            
            <!-- Actions sur l'entit√© -->
            <div class="entity-actions">
              <button id="activate-entity-btn" class="btn-blue">
                ‚úì Activer cette entit√©
              </button>
              <button id="rename-entity-btn" class="btn-gray">
                ‚úèÔ∏è Renommer
              </button>
              <button id="delete-entity-btn" class="btn-red">
                üóëÔ∏è Supprimer
              </button>
            </div>
            
            <!-- Upload SVG -->
            <div class="entity-upload-section">
              <h4>üìÅ Cartographie SVG</h4>
              <div id="entity-dropzone" class="dropzone">
                Glissez un fichier SVG ici ou cliquez pour s√©lectionner
              </div>
              <div id="entity-dropzone-status"></div>
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>

  <!-- ============================================================
       POPUP ACTIONS CARTOGRAPHIE
  ============================================================ -->
  <div id="carto-actions-popup" class="popup hidden">
    <div class="popup-content">
      <h2>Actions sur la cartographie</h2>

      <!-- SECTION 1: Upload/Rechargement de cartographie -->
      <div class="action-section">
        <h3>üì§ Mettre √† jour la cartographie</h3>
        <p class="info-text-small">
          Glissez un fichier SVG export√© depuis Visio pour mettre √† jour la cartographie.
        </p>
        <div id="carto-dropzone" class="dropzone">
          <span class="dropzone-icon">üìÅ</span>
          <span>Glissez votre fichier SVG ici</span>
          <span class="dropzone-hint">ou cliquez pour s√©lectionner</span>
          <input type="file" id="carto-file-input" accept=".svg" hidden>
        </div>
        <div id="carto-dropzone-status"></div>
      </div>

      <hr>

      <!-- SECTION 2: Synchronisation -->
      <div class="action-section">
        <h3>üîÑ Synchronisation</h3>
        <button id="resync-activities-btn" class="btn-green">
          üîÑ Re-synchroniser les activit√©s
        </button>
        <p class="info-text-small">
          V√©rifie les diff√©rences entre le SVG et la base de donn√©es.
        </p>
      </div>

      <hr>

      <button id="close-popup" class="btn-red">Fermer</button>
    </div>
  </div>

  <!-- ============================================================
       MODAL DE CONFIRMATION SUPPRESSION
  ============================================================ -->
  <div id="confirm-delete-modal" class="modal hidden">
    <div class="modal-content modal-danger">
      <h3>‚ö†Ô∏è Confirmer la suppression</h3>
      <p id="delete-warning-text">
        √ätes-vous s√ªr de vouloir supprimer cette entit√© ?
      </p>
      <p class="delete-warning-detail">
        <strong>ATTENTION :</strong> Cette action supprimera d√©finitivement :
      </p>
      <ul class="delete-consequences">
        <li>Toutes les activit√©s de cette entit√©</li>
        <li>Toutes les t√¢ches associ√©es</li>
        <li>Tous les r√¥les et comp√©tences</li>
        <li>Tous les savoirs, savoir-faires et aptitudes</li>
        <li>Toutes les analyses de temps</li>
        <li>La cartographie SVG</li>
      </ul>
      <p class="delete-warning-final">Cette action est <strong>IRR√âVERSIBLE</strong>.</p>
      
      <div class="modal-actions">
        <button id="cancel-delete-btn" class="btn-gray">Annuler</button>
        <button id="confirm-delete-btn" class="btn-red">üóëÔ∏è Supprimer d√©finitivement</button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       MODAL DE RENOMMAGE
  ============================================================ -->
  <div id="rename-modal" class="modal hidden">
    <div class="modal-content">
      <h3>‚úèÔ∏è Renommer l'entit√©</h3>
      <input type="text" id="rename-input" placeholder="Nouveau nom" />
      <div class="modal-actions">
        <button id="cancel-rename-btn" class="btn-gray">Annuler</button>
        <button id="confirm-rename-btn" class="btn-blue">Renommer</button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       CONTENU PRINCIPAL
  ============================================================ -->
  <div class="carto-container">

    <!-- SVG (charg√© inline par JavaScript) -->
    <div class="carto-left">

      <div class="carto-toolbar">
        <button id="carto-zoom-out">‚àí</button>
        <button id="carto-zoom-reset">100%</button>
        <button id="carto-zoom-in">+</button>
      </div>

      <div id="carto-pan-wrapper" class="carto-pan-wrapper">
        <div id="pan-inner">
          <!-- Le SVG sera charg√© ici par JavaScript -->
          <div id="svg-container"></div>
        </div>
      </div>

    </div>

    <!-- LISTE ACTIVIT√âS -->
    <div class="carto-right">
      <h2>Liste des activit√©s</h2>

      {% if activities %}
        <ul class="activities-list">
          {% for a in activities %}
            <li class="activity-item" data-id="{{ a.id }}">
              <span class="num">{{ loop.index }}</span>
              <span class="label">{{ a.name }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="no-activities">
          <p>Aucune activit√© pour cette entit√©.</p>
          <p class="hint">Cr√©ez des activit√©s depuis la page "Liste des activit√©s".</p>
        </div>
      {% endif %}
        </div>
    </div>

  </div>

</div>